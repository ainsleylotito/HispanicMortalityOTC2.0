---
title: "Cleaning"
output: html_document
--- 
```{r setup}
# Load packages
library(tidyverse)
library(ggplot2) 
library(readxl) 
library(lubridate)

# Global options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

# Mortality Data 
## 1999-2013 
```{r importm99}
mortality99_13 <- read.csv("../RawData/cdph/2021-05-14_deaths_final_1999_2013_state_year_sup.csv")
```

First, we need to restrict the dataset to only observations with CA residents. We will do so by restricting the data to only cases where the `Geography_Type` column is "Residence", as per the data dictionary definition: 

**Whether the geography is based on the place of residence or place of occurrence. A geography type of Residence includes events for California residents even if they occurred outside of California, whereas a geography type of Occurrence includes events that occurred within California even if they were not California residents.** 

```{r residents}
table(mortality99_13$Geography_Type) 
mortality99_13 <- mortality99_13 %>% 
  filter(Geography_Type == "Residence")
```
There were the same count of occurrence and residence deaths. This makes sense, as there should be a row for each residence type and strata. After restricting the data, we have 2744 observations. 

```{r tidy_99}
glimpse(mortality99_13)


```
We will retain this data to calculate an all-cause mortality count, but we also need to create another dataframe that only includes the Cause of Death included in the analysis.

Next, we are going to apply the exclusion criteria and recode the ICD codes into the same groups used in [Vaca et al. (2011)](https://pubmed.ncbi.nlm.nih.gov/21134905/): 

*"The ICD-10 underlying cause of death codes were grouped as follows: disease (001-294), motor vehicle (296-306), suicide (331-337), homicide (338-346), and all other injury (295, 307-330, 347-358). We restricted the data to three racial and ethnic groups: Latinos (defined as having Hispanic ethnicity and any race), non-Latino whites, and non-Latino blacks. We used race and ethnicity data recorded on the death certificate."* 

```{r}
#mortality99_13_icd
```

## 2014-2023
```{r importm14}
mortality14_23 <- read.csv("../RawData/cdph/20250116_deaths_final_2014_2023_state_year_sup.csv")
table(mortality14_23$Geography_Type) #checking counts of Residents/Non-Residents 

mortality14_23 <- mortality14_23 %>% 
  filter(Geography_Type == "Residence",
         Strata != "Place Type")
```


### All-cause mortality 
We are going to merge the mortality datasets so we may calculate all-cause mortality rates. We will start by looking at how many unique combinations of Gender, Age, and Race_Eth exist for the All-cause mortality data within each set.

```{r all_cause_data}
mortality99_13 %>%
  filter(Cause == "ALL") %>%
  count(Year, Strata, name = "n_rows") 

mortality14_23 %>%
  filter(Cause == "ALL") %>%
  count(Year, Strata, name = "n_rows")


mortality14_23_all <- mortality14_23 %>% 
  filter(Cause == "ALL") %>% 
  select(Year, Strata, Strata_Name, Count) 
glimpse(mortality14_23_all) #481 rows

mortality99_13_all <- mortality99_13 %>% 
   filter(Cause == "ALL") %>% 
 select(Year, Strata, Strata_Name, Count)
glimpse(mortality99_13_all) #546 rows

all_cause_mort <- full_join(mortality99_13_all, mortality14_23_all)  
glimpse(all_cause_mort)
range(all_cause_mort$Year)
write_csv(all_cause_mort, "../CleanData/all_cause_mort.csv")
```



## CDC Wonder

This is just where I am going to import all of the data from CDC Wonder. The goal of this data cleaning process will be to add a col for race_eth, add a cause of death (cod) column, and merge all my data. 

Let's start just with the all-cause mortality datasets. I am going to make a cleaning function for both white_black dfs and hispanic dfs that can be reused for the rest of this process.

```{r all_cause_cdc}
#function creation 
white_black_clean <- function(df, cod_character) {

  df <- df %>% 
    select(
      -any_of(c("Notes",
                "Five.Year.Age.Groups.Code",
                "Year.Code",
                "Sex.Code",
                "Race.Code",
                "Single.Race.6.Code",
                "Population"))
    )

  if ("Race" %in% names(df)) {
    df <- df %>% rename(race_eth = Race)
  } else if ("Single.Race.6" %in% names(df)) {
    df <- df %>% rename(race_eth = Single.Race.6)
  }

  df %>% 
    rename(age_group = Five.Year.Age.Groups) %>% 
        rename_with(tolower) %>% 
    mutate(
      cod = cod_character,
      deaths = as.numeric(deaths),
      year = as.integer(year)
    ) %>% 
    filter(!is.na(year))
}



hispanic_clean <- function(df, cod_character) {

  df %>% 
    select(
      -any_of(c("Notes",
                "Five.Year.Age.Groups.Code",
                "Year.Code",
                "Sex.Code",
                "Population"))
    ) %>% 
    rename(age_group = Five.Year.Age.Groups) %>% 
    rename_with(tolower) %>% 
    mutate(
      cod = cod_character,
      race_eth = "Hispanic",
      deaths = as.numeric(deaths),
      year = as.integer(year)
    ) %>% 
    filter(!is.na(year))
}



#all_cause datasets
all_cause_white_black_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/all_cause/All_Cause_White_Black.csv")
all_cause_hispanic_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/all_cause/All_Cause_Hispanic.csv") 
all_cause_white_black_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/All_Cause/All_Cause_White_Black.csv")
all_cause_hispanic_18_23    <- read.csv("../RawData/cdcWONDER/2018_2023/All_Cause/All_Cause_Hispanic.csv")


#cleaning all cause 
all_cause_white_black_99_17_clean <- white_black_clean(all_cause_white_black_99_17, "all_cause")
all_cause_hispanic_99_17_clean <- hispanic_clean(all_cause_hispanic_99_17, "all_cause") 
all_cause_white_black_18_23_clean <- white_black_clean(all_cause_white_black_18_23, "all_cause")
all_cause_hispanic_18_23_clean <- hispanic_clean(all_cause_hispanic_18_23, "all_cause")  


#homicide datasets 
hom__white_black_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/homicide/Homicide_White_Black.csv")
hom_hispanic_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/homicide/Homicide_Hispanic.csv")
hom_white_black_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Homicide/Homicide_White_Black.csv")
hom_hispanic_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Homicide/Homicide_Hispanic.csv")

#homicide cleaning 
hom_white_black_99_17_clean <- white_black_clean(
  hom__white_black_99_17,
  cod_character = "homicide"
)

hom_white_black_18_23_clean <- white_black_clean(
  hom_white_black_18_23,
  cod_character = "homicide"
)

hom_hispanic_99_17_clean <- hispanic_clean(
  hom_hispanic_99_17,
  cod_character = "homicide"
)

hom_hispanic_18_23_clean <- hispanic_clean(
  hom_hispanic_18_23,
  cod_character = "homicide"
)


#mvc datasets 
mvc_hispanic_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/mvc/MVC_Hispanic.csv")
mvc_white_black_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/mvc/MVC_White_Black.csv")
mvc_white_black_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/MVC/MVC_White_Black.csv")
mvc_hispanic_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/MVC/MVC_Hispanic.csv")

#mvc cleaning 
mvc_white_black_99_17_clean <- white_black_clean(
  mvc_white_black_99_17,
  cod_character = "mvc"
)

mvc_white_black_18_23_clean <- white_black_clean(
  mvc_white_black_18_23,
  cod_character = "mvc"
)

mvc_hispanic_99_17_clean <- hispanic_clean(
  mvc_hispanic_99_17,
  cod_character = "mvc"
)

mvc_hispanic_18_23_clean <- hispanic_clean(
  mvc_hispanic_18_23,
  cod_character = "mvc"
)


#other_disease datasets 
disease_hispanic_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/other_disease/Disease_Hispanic.csv")
disease_white_black_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/other_disease/Disease_White_Black.csv")
disease_white_black_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Other_Disease/Other_Disease_White_Black.csv")
disease_hispanic_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Other_Disease/Other_Disease_Hispanic.csv")

#other_disease cleaning 
disease_white_black_99_17_clean <- white_black_clean(
  disease_white_black_99_17,
  cod_character = "other_disease"
)

disease_white_black_18_23_clean <- white_black_clean(
  disease_white_black_18_23,
  cod_character = "other_disease"
)

disease_hispanic_99_17_clean <- hispanic_clean(
  disease_hispanic_99_17,
  cod_character = "other_disease"
)

disease_hispanic_18_23_clean <- hispanic_clean(
  disease_hispanic_18_23,
  cod_character = "other_disease"
)


#other_injuries datasets 
inj_hispanic_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/other_injuries/Injuries_Hispanic.csv")
inj_white_black_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/other_injuries/Injuries_White_Black.csv")
inj_white_black_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Other_Injury/Other_Injury_White_Black.csv")
inj_hispanic_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Other_Injury/Other_Injury_Hispanic.csv")

#other_injuries cleaning 
inj_white_black_99_17_clean <- white_black_clean(
  inj_white_black_99_17,
  cod_character = "other_injury"
)

inj_white_black_18_23_clean <- white_black_clean(
  inj_white_black_18_23,
  cod_character = "other_injury"
)

inj_hispanic_99_17_clean <- hispanic_clean(
  inj_hispanic_99_17,
  cod_character = "other_injury"
)

inj_hispanic_18_23_clean <- hispanic_clean(
  inj_hispanic_18_23,
  cod_character = "other_injury"
)


#suicide datasets 
sui_hispanic_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/suicide/Suicide_Hispanic.csv")
sui_white_black_99_17 <- read.csv("../RawData/cdcWONDER/1999_2017/suicide/Suicide_White_Black.csv")
sui_white_black_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Suicide/Suicide_White_Black.csv")
sui_hispanic_18_23 <- read.csv("../RawData/cdcWONDER/2018_2023/Suicide/Suicide_Hispanic.csv")

#suicide cleaning
sui_white_black_99_17_clean <- white_black_clean(
  sui_white_black_99_17,
  cod_character = "suicide"
)

sui_white_black_18_23_clean <- white_black_clean(
  sui_white_black_18_23,
  cod_character = "suicide"
)

sui_hispanic_99_17_clean <- hispanic_clean(
  sui_hispanic_99_17,
  cod_character = "suicide"
)

sui_hispanic_18_23_clean <- hispanic_clean(
  sui_hispanic_18_23,
  cod_character = "suicide"
)

```

Merging the cleaned data: 
```{r bind_rows}

all_cleaned <- bind_rows(
  # all-cause
  all_cause_white_black_99_17_clean,
  all_cause_white_black_18_23_clean,
  all_cause_hispanic_99_17_clean,
  all_cause_hispanic_18_23_clean,

  # homicide
  hom_white_black_99_17_clean,
  hom_white_black_18_23_clean,
  hom_hispanic_99_17_clean,
  hom_hispanic_18_23_clean,

  # MVC
  mvc_white_black_99_17_clean,
  mvc_white_black_18_23_clean,
  mvc_hispanic_99_17_clean,
  mvc_hispanic_18_23_clean,

  # other disease
  disease_white_black_99_17_clean,
  disease_white_black_18_23_clean,
  disease_hispanic_99_17_clean,
  disease_hispanic_18_23_clean,

  # other injury
  inj_white_black_99_17_clean,
  inj_white_black_18_23_clean,
  inj_hispanic_99_17_clean,
  inj_hispanic_18_23_clean,

  # suicide
  sui_white_black_99_17_clean,
  sui_white_black_18_23_clean,
  sui_hispanic_99_17_clean,
  sui_hispanic_18_23_clean
)

glimpse(all_cleaned)

count(all_cleaned, cod)

count(all_cleaned, cod, race_eth)

range(all_cleaned$year, na.rm = TRUE)  

all_cleaned <- all_cleaned %>%
  select(-"single.race.6", -"single.race.6.code")

#saving my data 
write_csv(all_cleaned, "../CleanData/cdc_mortality.csv")

```
# Population Data 

Next, we are going to import the Population Estimates from 2001-2025 from the DOF. There are 3 separate datasets we will need to clean and merge (2001-2010, 2011-2020, 2021-2025). 

### 2000-2010  

I was unable to locate an Intercensal estimate record that was statewide, just county-level. We will have to sum the values for corresponding Year, Race, Gender, and Age to get the state-level total. 

We need to do some cleaning to make the variables consistent with other datasets. We will convert the Year to a proper "date" variable and select only the races/ethnic groups to be used in the study.

```{r dof1}
dof1 <- read.csv("../RawData/dof/Intercensal_2000-2010_DBInput_csv/Intercensal_2000-2010_DBInput_csv.txt") 
head(dof1) 

dof1 <- dof1 %>%
  mutate(
    year = year(mdy_hms(Year)),  # convert Year to numeric
    age = as.numeric(Age),
    population = as.numeric(Population),
    race_eth = str_to_lower(RaceName),
    sex = str_to_lower(Gender)
  )

dof1 <- dof1 %>%
  filter(race_eth %in% c("white", "black", "hispanic"))

dof1_tidy <- dof1 %>%
  group_by(year, race_eth, sex, age) %>%
  summarise(population = sum(population, na.rm = TRUE), .groups = "drop") %>%
  arrange(year, race_eth, sex, age)

nrow(dof1_tidy) 

``` 


### 2010-2020 

```{r dof2}
dof2 <- read_excel("../RawData/dof/Intercensal_Excel_California.xlsx",
                   sheet = "California-State",
                   col_names = TRUE) 
dof2 <- dof2 %>% 
  select(Sex:"April 1, 2020") %>% 
  rename(age = "Age (0-100+)",
         race_eth = "Race/ethnicity recode") %>% 
  rename_with(tolower)
 
```
Each row contains the population count for a given age, race, and sex. We are going to tidy this data by making a new "Year" variable and "Population" variable to contain the values that are in wide format right now. We also have two population values for 2010 (April, when the census took effect, then July). We will retain just the April counts, as they require no estimation and are the most accurate approximation of the population that year. 

```{r tidy_dof2}
dof2_tidy <- pivot_longer(dof2,
                     cols = 'april 1, 2010':'april 1, 2020',
                     names_to = "Year",
                     values_to = "Population")
dof2_tidy <- dof2_tidy %>% 
  filter(Year != "july 1, 2010") %>% 
  mutate(
    Year = year(mdy(Year)),
    sex = str_to_lower(sex)
  ) %>% 
   rename_with(tolower) %>% 
  filter(race_eth %in% c("White NH", "Black NH", "Hispanic")) %>% 
  mutate(race_eth = recode(
    race_eth, 
    "White NH" = "White", 
    "Black NH" = "Black"),
    race_eth = str_to_lower(race_eth),
    population = as.numeric(population)
  )
  
```
Now that our datasets have consistent tidy structure and naming conventions, we can stack them. 

```{r merge}
#Checking counts prior to merge
nrow(dof1_tidy) #6666
nrow(dof2_tidy) #6666

dof_data <- full_join(dof1_tidy, dof2_tidy)
head(dof_data) 
nrow(dof_data) #13332, correct number of observations
```

We will have two dataframes, one with the continuous ages so we may replicate one of the figures that has trends by each individual age. We will create a different dataframe that have age groups separately.   

```{r age_groups}
age_breaks <- c(seq(0, 90, by = 5), Inf)  # 0,5,10,...,90, Inf
age_labels <- c(paste(seq(0, 85, by = 5), seq(4, 89, by = 5), sep = "-"), "90+")

dof_data_grouped <- dof_data %>%
  mutate(age_group = cut(age, breaks = age_breaks, labels = age_labels, right = TRUE, include.lowest = TRUE)) %>%
  group_by(sex, race_eth, age_group, year) %>%
  summarise(population = sum(population, na.rm = TRUE), .groups = "drop") 
head(dof_data_grouped) 
```
## 2021-2025

For 2021-2025, the only option (that I can ascertain) is to use the population projections for the years 2021-2025. We will be using the "Complete P-3 Race/Ethnicity and Sex by Age for California and Counties, Excel Compatible" California-State section from the [Projection webpage of the dof](https://dof.ca.gov/forecasting/demographics/projections/). 

```{r dof3}
dof3 <- read_excel("../RawData/dof/Projections/P3_California-and-Counties.xlsx",
                   sheet = "California-State",
                   col_names = TRUE) 
dof3 <- dof3 %>% 
  select(Sex:"2025", -"2020") %>% 
  rename(age = "Age (0-110+)",
         race_eth = "Race/ethnicity recode") %>% 
  rename_with(tolower) %>% 
  filter(race_eth %in% c(1,2,7)) %>% 
  mutate(sex = str_to_lower(sex),
         race_eth = recode(
    race_eth, 
    "1" = "White", 
    "2" = "Black",
    "7" = "Hispanic")) %>% 
  pivot_longer(
                     cols = '2021':'2025',
                     names_to = "year",
                     values_to = "population"
                     )
```

I am also going to create a dataset that is just the population by gender and race_eth, ignoring age all together. 

```{r}
dof_no_age <- dof_data %>% 
  group_by(year, race_eth, sex) %>% 
  summarize(population = sum(population))
  
```
#Saving population datasets 

```{r save}
write_csv(dof_data_grouped, "../CleanData/dof_data_grouped.csv") 
write_csv(dof_data, "../CleanData/dof_data.csv")
write_csv(dof_no_age, "../CleanData/dof_no_age.csv")
```

