---
title: "Cleaning"
output: html_document
--- 
```{r setup}
# Load packages
library(tidyverse)
library(ggplot2) 
library(readxl) 
library(lubridate)

# Global options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

# Mortality Data 
## 1999-2013 
```{r importm99}
mortality99_13 <- read.csv("../RawData/cdph/2021-05-14_deaths_final_1999_2013_state_year_sup.csv")
```

First, we need to restrict the dataset to only observations with CA residents. We will do so by restricting the data to only cases where the `Geography_Type` column is "Residence", as per the data dictionary definition: 

**Whether the geography is based on the place of residence or place of occurrence. A geography type of Residence includes events for California residents even if they occurred outside of California, whereas a geography type of Occurrence includes events that occurred within California even if they were not California residents.** 

```{r residents}
table(mortality99_13$Geography_Type) 
mortality99_13 <- mortality99_13 %>% 
  filter(Geography_Type == "Residence")
```
There were the same count of occurrence and residence deaths. This makes sense, as there should be a row for each residence type and strata. After restricting the data, we have 2744 observations.  

Next, we are going to apply the exclusion criteria and recode the ICD codes into the same groups used in [Vaca et al. (2011)](https://pubmed.ncbi.nlm.nih.gov/21134905/): 

*"The ICD-10 underlying cause of death codes were grouped as follows: disease (001-294), motor vehicle (296-306), suicide (331-337), homicide (338-346), and all other injury (295, 307-330, 347-358). We restricted the data to three racial and ethnic groups: Latinos (defined as having Hispanic ethnicity and any race), non-Latino whites, and non-Latino blacks. We used race and ethnicity data recorded on the death certificate."* 

```{r}
mortality99_13
```

## 2014-2023
```{r importm14}
mortality14_23 <- read.csv("../RawData/cdph/20250116_deaths_final_2014_2023_state_year_sup.csv")
table(mortality14_23$Geography_Type) #checking counts of Residents/Non-Residents
```
# Population Data 

Next, we are going to import the Population Estimates from 2001-2025 from the DOF. There are 3 separate datasets we will need to clean and merge (2001-2010, 2011-2020, 2021-2025). 

### 2000-2010  

I was unable to locate an Intercensal estimate record that was statewide, just county-level. We will have to sum the values for corresponding Year, Race, Gender, and Age to get the state-level total. 

We need to do some cleaning to make the variables consistent with other datasets. We will convert the Year to a proper "date" variable and select only the races/ethnic groups to be used in the study.

```{r dof1}
dof1 <- read.csv("../RawData/dof/Intercensal_2000-2010_DBInput_csv/Intercensal_2000-2010_DBInput_csv.txt") 
head(dof1) 

dof1 <- dof1 %>%
  mutate(
    year = year(mdy_hms(Year)),  # convert Year to numeric
    age = as.numeric(Age),
    population = as.numeric(Population),
    race_eth = str_to_lower(RaceName),
    sex = str_to_lower(Gender)
  )

dof1 <- dof1 %>%
  filter(race_eth %in% c("white", "black", "hispanic"))

dof1_tidy <- dof1 %>%
  group_by(year, race_eth, sex, age) %>%
  summarise(population = sum(population, na.rm = TRUE), .groups = "drop") %>%
  arrange(year, race_eth, sex, age)

nrow(dof1_tidy) 

``` 


### 2010-2020 

```{r dof2}
dof2 <- read_excel("../RawData/dof/Intercensal_Excel_California.xlsx",
                   sheet = "California-State",
                   col_names = TRUE) 
dof2 <- dof2 %>% 
  select(Sex:"April 1, 2020") %>% 
  rename(age = "Age (0-100+)",
         race_eth = "Race/ethnicity recode") %>% 
  rename_with(tolower)
 
```
Each row contains the population count for a given age, race, and sex. We are going to tidy this data by making a new "Year" variable and "Population" variable to contain the values that are in wide format right now. We also have two population values for 2010 (April, when the census took effect, then July). We will retain just the April counts, as they require no estimation and are the most accurate approximation of the population that year. 

```{r tidy_dof2}
dof2_tidy <- pivot_longer(dof2,
                     cols = 'april 1, 2010':'april 1, 2020',
                     names_to = "Year",
                     values_to = "Population")
dof2_tidy <- dof2_tidy %>% 
  filter(Year != "july 1, 2010") %>% 
  mutate(
    Year = year(mdy(Year)),
    sex = str_to_lower(sex)
  ) %>% 
   rename_with(tolower) %>% 
  filter(race_eth %in% c("White NH", "Black NH", "Hispanic")) %>% 
  mutate(race_eth = recode(
    race_eth, 
    "White NH" = "White", 
    "Black NH" = "Black"),
    race_eth = str_to_lower(race_eth),
    population = as.numeric(population)
  )
  
```
Now that our datasets have consistent tidy structure and naming conventions, we can stack them. 

```{r merge}
#Checking counts prior to merge
nrow(dof1_tidy) #6666
nrow(dof2_tidy) #6666

dof_data <- full_join(dof1_tidy, dof2_tidy)
head(dof_data) 
nrow(dof_data) #13332, correct number of observations
```

We will have two dataframes, one with the continuous ages so we may replicate one of the figures that has trends by each individual age. We will create a different dataframe that have age groups separately.   

```{r age_groups}
age_breaks <- c(seq(0, 90, by = 5), Inf)  # 0,5,10,...,90, Inf
age_labels <- c(paste(seq(0, 85, by = 5), seq(4, 89, by = 5), sep = "-"), "90+")

dof_data_grouped <- dof_data %>%
  mutate(age_group = cut(age, breaks = age_breaks, labels = age_labels, right = TRUE, include.lowest = TRUE)) %>%
  group_by(sex, race_eth, age_group, year) %>%
  summarise(population = sum(population, na.rm = TRUE), .groups = "drop") 
head(dof_data_grouped) 
```
## 2021-2025

????

#Exploring population data 
We are going to explore the distribution of our population data by individual ages and age categories, respectively. 

```{r explore_population}


```

Let's examine the trends for the whole study period (data for 2000-2009):
```{r explore_age_groups} 
agg_data <- dof_data_grouped %>%
  group_by(race_eth, age_group) %>%
  summarise(total_population = sum(population, na.rm = TRUE)) %>%
  ungroup() %>%
  # convert to per 100,000
  mutate(pop_per_100k = total_population / 100000)

ggplot(agg_data, aes(x = age_group, y = pop_per_100k, color = race_eth, group = race_eth)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Overall Population by Age Group and Race/Ethnicity (per 100,000)",
    x = "Age Group",
    y = "Population per 100,000",
    color = "Race/Ethnicity"
  ) +
  theme_minimal()


``` 

Now let's look through the decades: 
```{r}
agg_period <- dof_data_grouped %>%
  mutate(period = case_when(
    year >= 2000 & year <= 2009 ~ "2000-2009",
    year >= 2010 & year <= 2020 ~ "2010-2020",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(period)) %>%
  group_by(race_eth, age_group, period) %>%
  summarise(total_population = sum(population, na.rm = TRUE)) %>%
  ungroup() %>% 
   mutate(pop_per_100k = total_population / 100000)

ggplot(agg_period, aes(x = age_group, y = pop_per_100k, color = race_eth, group = race_eth)) +
  facet_wrap(~period)+
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Overall Population by Age Group and Race/Ethnicity (per 100,000)",
    x = "Age Group",
    y = "Population per 100,000",
    color = "Race/Ethnicity"
  ) +
  theme_minimal()

```
#sex differences 
ggplot(dof_data_grouped, aes(x = year, y = population, color = sex)) +
  geom_line() +
  facet_wrap(~age_group) +
  labs(title = "Population by Sex Over Time")

```
