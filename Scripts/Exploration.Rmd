---
title: "Exploration"
output: html_document
---
```{r setup}
# Load packages
library(tidyverse)
library(ggplot2) 
library(readxl) 
library(lubridate)
library(ggthemes)

# Global options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```
#Exploring population data 
We are going to explore the distribution of our population data by individual ages and age categories, respectively. 

```{r explore_population}
dof_data_grouped <- read.csv("../CleanData/dof_data_grouped.csv")
dof_data <- read.csv("../CleanData/dof_data.csv")
```

Let's examine the trends for the whole study period (data for 2000-2009):
```{r explore_age_groups} 
agg_data <- dof_data_grouped %>%
  group_by(race_eth, age_group) %>%
  summarise(total_population = sum(population, na.rm = TRUE)) %>%
  ungroup() %>%
  # convert to per 100,000
  mutate(pop_per_100k = total_population / 100000)

ggplot(agg_data, aes(x = age_group, y = pop_per_100k, color = race_eth, group = race_eth)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Overall Population by Age Group and Race/Ethnicity (per 100,000)",
    x = "Age Group",
    y = "Population per 100,000",
    color = "Race/Ethnicity"
  ) +
  theme_minimal()


``` 

Now let's look through the decades: 
```{r}
agg_period <- dof_data_grouped %>%
  mutate(period = case_when(
    year >= 2000 & year <= 2009 ~ "2000-2009",
    year >= 2010 & year <= 2020 ~ "2010-2020",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(period)) %>%
  group_by(race_eth, age_group, period) %>%
  summarise(total_population = sum(population, na.rm = TRUE)) %>%
  ungroup() %>% 
   mutate(pop_per_100k = total_population / 100000)

ggplot(agg_period, aes(x = age_group, y = pop_per_100k, color = race_eth, group = race_eth)) +
  facet_wrap(~period, ncol = 1) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Overall Population by Age Group and Race/Ethnicity (per 100,000)",
    x = "Age Group",
    y = "Population per 100,000",
    color = "Race/Ethnicity"
  ) +
  theme_minimal()

```
#sex differences 
```{r}
ggplot(dof_data_grouped, aes(x = year, y = population, color = sex)) +
  geom_line() +
  facet_wrap(~age_group) +
  labs(title = "Population by Sex Over Time")

```


#All-cause mortality
To start, let's just look at all-cause mortality for males by racial/ethnic group. We are going to create a new dataframe for just this information: 
```{r all_cause_mort}
all_cause_mort <- read.csv("../CleanData/all_cause_mort.csv")
unique(all_cause_mort$Strata_Name)

race_eth_all_cause <- all_cause_mort %>% 
  filter(Strata_Name %in% c("Female * Black", 
                            "Female * Hispanic", "Female * White",
                            "Male * Black", "Male * Hispanic",
                            "Male * White")) #excluding deaths for Multi-Race and Other/Unknown 

race_eth_all_cause <- race_eth_all_cause %>% #tidying
  separate(
    Strata_Name,
    into = c("sex", "race_eth"),
    sep = " \\* "
  ) %>% 
  select(-Strata) %>% 
  rename_with(tolower) %>% 
  mutate(sex = str_to_lower(sex),
         race_eth = str_to_lower(race_eth))
head(race_eth_all_cause)

```
Now that all of the naming conventions are the same as the population data, we can bring in the pop dataset and merge it with our race_eth_all_cause dataframe and calculate the death rate. We also need to apply the log-normal (Posson) CI for the rates.

```{r all_cause_with_pop}
dof_no_age <- read_csv("../CleanData/dof_no_age.csv")

all_cause_with_pop <- left_join(race_eth_all_cause,dof_no_age,
                                by = c("year", "sex", "race_eth"))

head(all_cause_with_pop) 

all_cause_with_pop <- all_cause_with_pop %>% 
  mutate( #mortality rate
          rate = count/population,
         rate_per_100k = rate*100000,
         
         # log-normal Poisson CI
    rate_lcl = rate * exp(-1.96 / sqrt(count)),
    rate_ucl = rate * exp( 1.96 / sqrt(count)),

    rate_lcl_100k = rate_lcl * 100000,
    rate_ucl_100k = rate_ucl * 100000)
head(all_cause_with_pop)
``` 


Let's summarize these trends: 

```{r all_c_no_age_trends}
all_cause_table <- all_cause_with_pop %>%
  mutate(
    rate_ci = sprintf(
      "%.1f (%.1f–%.1f)",
      rate_per_100k,
      rate_lcl_100k,
      rate_ucl_100k
    )
  )

#females
female_table <- all_cause_table %>%
  filter(sex == "female") %>%
  select(year, race_eth, rate_ci)

female_table

#males 
male_table <- all_cause_table %>%
  filter(sex == "male") %>%
  select(year, race_eth, rate_ci)

male_table

#sex stratified table
sex_stratified_table <- all_cause_table %>%
  select(year, sex, race_eth, rate_ci) %>%
  pivot_wider(
    names_from = sex,
    values_from = rate_ci
  )

sex_stratified_table
```

*Mortality rates are expressed per 100,000 persons. 95% confidence intervals were calculated using the log-normal approximation to the Poisson distribution.*

Now, we are going to plot. We are going to use White as the referent category. 
```{r plot_no_age_rr}
rr_data <- all_cause_with_pop %>%
  group_by(year, sex) %>%
  mutate(
    ref_rate  = rate[race_eth == "white"],
    ref_count = count[race_eth == "white"]
  ) %>%
  ungroup() %>%
  filter(race_eth != "white") %>%   # drop reference from RR plot
  mutate(
    rr = rate / ref_rate,
    rr_lcl = rr * exp(-1.96 * sqrt(1/count + 1/ref_count)),
    rr_ucl = rr * exp( 1.96 * sqrt(1/count + 1/ref_count))
  )
rr_data
#females
ggplot(
  rr_data %>% filter(sex == "female"),
  aes(x = year, y = rr, color = race_eth, group = race_eth)
) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(ymin = rr_lcl, ymax = rr_ucl),
    width = 0.15
  ) +
  labs(
    title = "Mortality Rate Ratios by Race/Ethnicity — Females",
    subtitle = "Reference group: White",
    x = "Year",
    y = "Rate Ratio"
  ) +
  theme_minimal()

#males 
ggplot(
  rr_data %>% filter(sex == "male"),
  aes(x = year, y = rr, color = race_eth, group = race_eth)
) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(ymin = rr_lcl, ymax = rr_ucl),
    width = 0.15
  ) +
  labs(
    title = "Mortality Rate Ratios by Race/Ethnicity — Males",
    subtitle = "Reference group: White",
    x = "Year",
    y = "Rate Ratio"
  ) +
  theme_minimal()

```

# CDC Mortality Data 
```{r cdc_merge}
cdc_mort <- read.csv("../CleanData/cdc_mortality.csv") 
head(cdc_mort)

#adding pop data 
dof_data<- read_csv("../CleanData/dof_data_grouped.csv")
head(dof_data)

#merging
cdc_with_pop <- left_join(cdc_mort,dof_data,
                                by = c("year", "sex", "race_eth", "age_group"))

head(cdc_with_pop)
```

We are missing the population for 1999 from dof, but we had the crude rate from the CDC data. We are going to calculate our death rate and compare with the "crude rate" supplied by the CDC wonder query.  

```{r cdc_rate} 
cdc_with_pop <- cdc_with_pop %>% 
  mutate( #mortality rate
          rate = deaths/population,
         rate_per_100k = rate*100000,
         
         # log-normal Poisson CI
    rate_lcl = rate * exp(-1.96 / sqrt(deaths)),
    rate_ucl = rate * exp( 1.96 / sqrt(deaths)),

    rate_lcl_100k = rate_lcl * 100000,
    rate_ucl_100k = rate_ucl * 100000)
head(cdc_with_pop)
```
The rate per 100k does not match the crude rate given by the CDC. I want to compare the rates calculated by Dr. Vaca and see how they match up. 

I think the easiest thing to match up is the table of annual mortality rates per 100,000 by cause of death and race/ethnic group among California males age 15-24 years, 1999-2006. 

To replicate the table, we need to:  
1. subset to males 15-24
2. collapse years 1999-2006 
3. use population data from 2000 to calculate overall rates

```{r table_1_replication} 
table1_2000_pop <- dof_data %>% 
  filter(
    year == 2000, 
    age_group %in% c("15-19", "20-24"),
    sex == "male"
  ) %>% 
  group_by(race_eth) %>%        # include sex
  summarise(
    pop_std_2000 = sum(population, na.rm = TRUE),  # sum 15-19 + 20-24
    .groups = "drop"
  )
table1_2000_pop


#selecting just the deaths for each age group from CDC data 
table1_data <- cdc_mort %>% 
  filter(
    year %in% 2000:2006, 
    age_group %in% c("15-19", "20-24"),
    sex == "male"
  ) %>% 
  group_by(race_eth, cod) %>% 
  summarise(
    death_count = sum(deaths, na.rm = TRUE),
    .groups = "drop"
  )
table1_data

#merging population data 
table1_data <- left_join(table1_data,
                         table1_2000_pop,
                         by = "race_eth")

table1_data



table1_data <- table1_data %>%
  mutate(
    rate_per_100k = death_count / pop_std_2000 * 100000,
    rate_lcl = (qchisq(0.025, 2 * death_count) / 2) / pop_std_2000 * 100000,
    rate_ucl = (qchisq(0.975, 2 * (death_count + 1)) / 2) / pop_std_2000 * 100000
  )


table1_data %>% 
  group_by(cod) %>% 
  select(cod, race_eth,rate_per_100k)

table1_final <- table1_data %>%
  select(cod, race_eth, rate_per_100k) %>%
  pivot_wider(
    names_from = race_eth,
    values_from = rate_per_100k
  )

table1_final

#poisson-based CI: 
#summary_tbl <- summary_tbl %>%
 # mutate(
 #   rate_lcl = (qchisq(0.025, 2 * deaths) / 2) / population / years,
   # rate_ucl = (qchisq(0.975, 2 * (deaths + 1)) / 2) / population / years,
   # rate_lcl_100k = rate_lcl * 100000,
  #  rate_ucl_100k = rate_ucl * 100000
  #)


```
None of the numbers match. Gr. Let's return to this later. In the meanwhile, I'd like to replicate figure 5 instead, as I think it may be easier to produce? 

Note: we have to get rid of 1999, we have no population data for that year.

```{r figure_5, fig.width=9, fig.height= 4}
fig5_data <- cdc_with_pop %>%
  filter(
    sex == "male",
    age_group %in% c("15-19", "20-24"),
    cod == "homicide",
    year >= 2000,
    year <= 2006
  )

fig5_yearly <- fig5_data %>%
  group_by(year, race_eth) %>%
  summarise(
    deaths = sum(deaths, na.rm = TRUE),
    population = sum(population, na.rm = TRUE),
    .groups = "drop"
  )

fig5_yearly <- fig5_yearly %>%
  mutate(
    rate = deaths / population,
    rate_per_100k = rate * 100000
  )

fig5_yearly <- fig5_yearly %>%
  mutate(
    rate_lcl = (qchisq(0.025, 2 * deaths) / 2) / population * 100000,
    rate_ucl = (qchisq(0.975, 2 * (deaths + 1)) / 2) / population * 100000
  )

fig5_yearly %>% arrange(desc(rate_per_100k))



ggplot(fig5_yearly,
       aes(x = year, y = rate_per_100k, color = race_eth)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(ymin = rate_lcl, ymax = rate_ucl),
    width = 0.2
  ) +
  scale_x_continuous(breaks = 2000:2006) +
  scale_y_continuous(
    name = "Mortality rate per 100,000"
  ) +
  scale_color_manual(
    values = c(
      "hispanic" = "#E69F00",
      "black" = "#000000",
      "white" = "#56B4E9"
    ),
    labels = c(
      "hispanic" = "Latino",
      "black" = "Non-Latino Black",
      "white" = "Non-Latino White"
    )
  ) +
  labs(
    title= "Homicide Mortality Rate, Males 15-24 y/o, 2000-2006",
    x = "Year",
    color = "Race/Ethnicity"
  ) +
 theme_minimal()

```

That's still not great, but let's see about replicating figure 7?? 

```{r figure_7, fig.width=9, fig.height= 4}
fig7_data <- cdc_with_pop %>%
  filter(
    sex == "male",
    age_group %in% c("15-19", "20-24"),
    cod == "mvc",
    year >= 2000,
    year <= 2006
  )

fig7_yearly <- fig7_data %>%
  group_by(year, race_eth) %>%
  summarise(
    deaths = sum(deaths, na.rm = TRUE),
    population = sum(population, na.rm = TRUE),
    .groups = "drop"
  )

fig7_yearly <- fig7_yearly %>%
  mutate(
    rate = deaths / population,
    rate_per_100k = rate * 100000
  )

fig7_yearly <- fig7_yearly %>%
  mutate(
    rate_lcl = (qchisq(0.025, 2 * deaths) / 2) / population * 100000,
    rate_ucl = (qchisq(0.975, 2 * (deaths + 1)) / 2) / population * 100000
  )

fig7_yearly %>% arrange(desc(rate_per_100k))




pd <- position_dodge(width = 0.3)

ggplot(fig7_yearly, aes(x = year, y = rate_per_100k, color = race_eth, linetype = race_eth)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2, position = pd) +
  geom_errorbar(aes(ymin = rate_lcl, ymax = rate_ucl), width = 0.2, position = pd) +
  scale_x_continuous(breaks = 2000:2006) +
  scale_y_continuous(name = "Mortality rate per 100,000") +
  
  # Custom colors
  scale_color_manual(
    values = c(
      "hispanic" = "black",       # Latino = solid black
      "black" = "#000000",        # Non-Latino Black = dotted
      "white" = "black"         # Non-Latino White = dashed blue
    ),
    labels = c(
      "hispanic" = "Latino",
      "black" = "Non-Latino Black",
      "white" = "Non-Latino White"
    )
  ) +
  
  # Custom linetypes
  scale_linetype_manual(
    values = c(
      "hispanic" = "solid",       # solid line
      "black" = "dotted",         # dotted (smaller dashes)
      "white" = "dashed"          # dashed
    )
  ) +
  
  labs(
    title = "Motor vehicle crash mortality rates males 15-24",
    x = "Year",
    color = "Race/Ethnicity",
    linetype = "Race/Ethnicity"
  ) +
  theme_minimal()

```
We are going to do the same thing, this time extending the data to go from years 2000-23: 


We are going to do the same thing, except this time we will 

```{r figure_7_extended, fig.width=11, fig.height= 6}
fig7x_data <- cdc_with_pop %>%
  filter(
    sex == "male",
    age_group %in% c("15-19", "20-24"),
    cod == "mvc",
    year >= 2006, 
    year < 2021
  )

fig7x_yearly <- fig7x_data %>%
  group_by(year, race_eth) %>%
  summarise(
    deaths = sum(deaths, na.rm = TRUE),
    population = sum(population, na.rm = TRUE),
    .groups = "drop"
  )

fig7x_yearly <- fig7x_yearly %>%
  mutate(
    rate = deaths / population,
    rate_per_100k = rate * 100000
  )

fig7x_yearly <- fig7x_yearly %>%
  mutate(
    rate_lcl = (qchisq(0.025, 2 * deaths) / 2) / population * 100000,
    rate_ucl = (qchisq(0.975, 2 * (deaths + 1)) / 2) / population * 100000
  )

fig7x_yearly %>% arrange(desc(rate_per_100k))




pd <- position_dodge(width = 0.3)

ggplot(fig7x_yearly, aes(x = year, y = rate_per_100k, color = race_eth, linetype = race_eth)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2, position = pd) +
  geom_errorbar(aes(ymin = rate_lcl, ymax = rate_ucl), width = 0.2, position = pd) +
  scale_x_continuous(breaks = 2006:2023) +
  scale_y_continuous(name = "Mortality rate per 100,000",
                     limits = c(0, 60) ) +
  
  # Custom colors
  scale_color_manual(
    values = c(
      "hispanic" = "black",       # Latino = solid black
      "black" = "#000000",        # Non-Latino Black = dotted
      "white" = "black"         # Non-Latino White = dashed blue
    ),
    labels = c(
      "hispanic" = "Latino",
      "black" = "Non-Latino Black",
      "white" = "Non-Latino White"
    )
  ) +
  
  # Custom linetypes
  scale_linetype_manual(
    values = c(
      "hispanic" = "solid",       # solid line
      "black" = "dotted",         # dotted (smaller dashes)
      "white" = "dashed"          # dashed
    )
  ) +
  
  labs(
    title = "Motor vehicle crash mortality rates males 15-24",
    x = "Year",
    color = "Race/Ethnicity",
    linetype = "Race/Ethnicity"
  ) +
  theme_minimal()

fig7x_table <- fig7x_yearly %>%
  select(year, race_eth, rate_per_100k) %>%
  pivot_wider(
    names_from = race_eth,       # new columns from race_eth
    values_from = rate_per_100k  # values to fill in
  )

fig7x_table
```
