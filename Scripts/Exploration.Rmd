---
title: "Exploration"
output: html_document
---

#Exploring population data 
We are going to explore the distribution of our population data by individual ages and age categories, respectively. 

```{r explore_population}
dof_data_grouped <- read.csv("../CleanData/dof_data_grouped.csv")
dof_data <- read.csv("../CleanData/dof_data.csv")
```

Let's examine the trends for the whole study period (data for 2000-2009):
```{r explore_age_groups} 
agg_data <- dof_data_grouped %>%
  group_by(race_eth, age_group) %>%
  summarise(total_population = sum(population, na.rm = TRUE)) %>%
  ungroup() %>%
  # convert to per 100,000
  mutate(pop_per_100k = total_population / 100000)

ggplot(agg_data, aes(x = age_group, y = pop_per_100k, color = race_eth, group = race_eth)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Overall Population by Age Group and Race/Ethnicity (per 100,000)",
    x = "Age Group",
    y = "Population per 100,000",
    color = "Race/Ethnicity"
  ) +
  theme_minimal()


``` 

Now let's look through the decades: 
```{r}
agg_period <- dof_data_grouped %>%
  mutate(period = case_when(
    year >= 2000 & year <= 2009 ~ "2000-2009",
    year >= 2010 & year <= 2020 ~ "2010-2020",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(period)) %>%
  group_by(race_eth, age_group, period) %>%
  summarise(total_population = sum(population, na.rm = TRUE)) %>%
  ungroup() %>% 
   mutate(pop_per_100k = total_population / 100000)

ggplot(agg_period, aes(x = age_group, y = pop_per_100k, color = race_eth, group = race_eth)) +
  facet_wrap(~period, ncol = 1) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Overall Population by Age Group and Race/Ethnicity (per 100,000)",
    x = "Age Group",
    y = "Population per 100,000",
    color = "Race/Ethnicity"
  ) +
  theme_minimal()

```
#sex differences 
```{r}
ggplot(dof_data_grouped, aes(x = year, y = population, color = sex)) +
  geom_line() +
  facet_wrap(~age_group) +
  labs(title = "Population by Sex Over Time")

```


#All-cause mortality
To start, let's just look at all-cause mortality for males by racial/ethnic group. We are going to create a new dataframe for just this information: 
```{r all_cause_mort}
all_cause_mort <- read.csv("../CleanData/all_cause_mort.csv")
unique(all_cause_mort$Strata_Name)

race_eth_all_cause <- all_cause_mort %>% 
  filter(Strata_Name %in% c("Female * Black", 
                            "Female * Hispanic", "Female * White",
                            "Male * Black", "Male * Hispanic",
                            "Male * White")) #excluding deaths for Multi-Race and Other/Unknown 

race_eth_all_cause <- race_eth_all_cause %>% #tidying
  separate(
    Strata_Name,
    into = c("sex", "race_eth"),
    sep = " \\* "
  ) %>% 
  select(-Strata) %>% 
  rename_with(tolower) %>% 
  mutate(sex = str_to_lower(sex),
         race_eth = str_to_lower(race_eth))
head(race_eth_all_cause)

```
Now that all of the naming conventions are the same as the population data, we can bring in the pop dataset and merge it with our race_eth_all_cause dataframe and calculate the death rate. We also need to apply the log-normal (Posson) CI for the rates.

```{r all_cause_with_pop}
dof_no_age <- read_csv("../CleanData/dof_no_age.csv")

all_cause_with_pop <- left_join(race_eth_all_cause,dof_no_age,
                                by = c("year", "sex", "race_eth"))

head(all_cause_with_pop) 

all_cause_with_pop <- all_cause_with_pop %>% 
  mutate( #mortality rate
          rate = count/population,
         rate_per_100k = rate*100000,
         
         # log-normal Poisson CI
    rate_lcl = rate * exp(-1.96 / sqrt(count)),
    rate_ucl = rate * exp( 1.96 / sqrt(count)),

    rate_lcl_100k = rate_lcl * 100000,
    rate_ucl_100k = rate_ucl * 100000)
head(all_cause_with_pop)
``` 


Let's summarize these trends: 

```{r all_c_no_age_trends}
all_cause_table <- all_cause_with_pop %>%
  mutate(
    rate_ci = sprintf(
      "%.1f (%.1fâ€“%.1f)",
      rate_per_100k,
      rate_lcl_100k,
      rate_ucl_100k
    )
  )

#females
female_table <- all_cause_table %>%
  filter(sex == "female") %>%
  select(year, race_eth, rate_ci)

female_table

#males 
male_table <- all_cause_table %>%
  filter(sex == "male") %>%
  select(year, race_eth, rate_ci)

male_table

#sex stratified table
sex_stratified_table <- all_cause_table %>%
  select(year, sex, race_eth, rate_ci) %>%
  pivot_wider(
    names_from = sex,
    values_from = rate_ci
  )

sex_stratified_table
```

*Mortality rates are expressed per 100,000 persons. 95% confidence intervals were calculated using the log-normal approximation to the Poisson distribution.*
